{% extends 'base.html' %}
{% block title %}Painel Administrativo{% endblock %}
{% block content %}
<section class="hero-card">
    <div>
        <p class="eyebrow">Centro Operacional</p>
        <div style="display: flex; align-items: center; gap: 12px;">
            <h2>Bem-vindo, {{ current_user.nome }}</h2>
            <a href="{{ url_for('logout') }}" title="Sair" style="opacity: 0.7; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            </a>
        </div>
        <p>Gerencie relatórios, usuários e veículos em um só lugar.</p>
        
        <!-- Preferências de Notificação -->
        <div style="margin-top: 12px; padding: 8px 12px; background-color: #f3f4f6; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; max-width: 400px;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4b5563" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                <span style="color: #374151; font-size: 0.875rem;">Notificações por e-mail (em breve)</span>
            </div>
            <label class="switch" title="Ativar/desativar notificações automáticas por e-mail">
                <input type="checkbox" id="notification-toggle" {% if current_user.notificacao %}checked{% endif %}>
                <span class="slider"></span>
            </label>
        </div>
    </div>
    <div class="hero-actions">
        {% if not open_trip %}
            <a class="btn btn-primary" href="{{ url_for('novo_relatorio') }}">Nova viagem</a>
        {% else %}
            <a class="btn btn-primary" href="{{ url_for('finalizar_relatorio') }}">Finalizar viagem</a>
        {% endif %}
        <a class="btn btn-secondary" href="{{ url_for('registrar_abastecimento') }}">Abastecimento</a>
        <a class="btn" href="{{ url_for('registrar_avaria') }}" style="background-color: #dc2626; color: white;">Registrar avaria</a>
    </div>
</section>

<section class="stats-grid">
    <a class="stat-card" href="{{ url_for('historico_relatorios') }}" style="cursor: pointer; text-decoration: none; color: inherit;">
        <div class="stat-header">
            <span class="stat-label">Viagens</span>
            <svg class="stat-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                <path d="M14 2v6h6M9 15h6M9 11h6"/>
            </svg>
        </div>
        <strong class="stat-value">{{ stats.relatorios }}</strong>
    </a>
    <a class="stat-card" href="{{ url_for('historico_avarias') }}" style="cursor: pointer; text-decoration: none; color: inherit;">
        <div class="stat-header">
            <span class="stat-label">Avarias</span>
            <svg class="stat-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
        </div>
        <strong class="stat-value">{{ stats.avarias }}</strong>
    </a>
    <a class="stat-card" href="{{ url_for('lista_usuarios') }}" style="cursor: pointer; text-decoration: none; color: inherit;">
        <div class="stat-header">
            <span class="stat-label">Usuários</span>
            <svg class="stat-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </div>
        <strong class="stat-value">{{ stats.usuarios }}</strong>
    </a>
    <a class="stat-card" href="{{ url_for('gerenciar_veiculos') }}" style="cursor: pointer; text-decoration: none; color: inherit;">
        <div class="stat-header">
            <span class="stat-label">Veículos</span>
            <svg class="stat-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm11 0c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM5 11l1.5-4.5h11L19 11H5z"/>
            </svg>
        </div>
        <strong class="stat-value">{{ stats.veiculos }}</strong>
    </a>
    <a class="stat-card" href="{{ url_for('historico_abastecimentos') }}" style="cursor: pointer; text-decoration: none; color: inherit;">
        <div class="stat-header">
            <span class="stat-label">Abastecimentos</span>
                <svg class="stat-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M7 2h6a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/>
                    <path d="M9 6h2"/>
                    <path d="M15 7v6.5a2.5 2.5 0 1 0 5 0V9.5L17.5 7H15"/>
                    <path d="M15 5h2.5L20 7.5"/>
                </svg>
        </div>
        <strong class="stat-value">{{ stats.abastecimentos }}</strong>
    </a>
</section>

<section class="card">
    <header class="section-header">
        <h3>Viagens em andamento</h3>
        <p>Controle os veículos que estão fora da base neste momento.</p>
    </header>

    {% if viagens_abertas %}
        <div class="table-wrapper">
            <table class="vehicles-table">
                <thead>
                    <tr>
                        <th>Placa / Condutor</th>
                        <th class="hide-mobile">Saída</th>
                        <th class="hide-mobile">KM inicial</th>
                        <th class="hide-mobile">Combustível</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for viagem in viagens_abertas %}
                        {% set cab = viagem.saida_info or {} %}
                        {% set veiculo = viagem.veiculo or {} %}
                        <tr>
                            <td>
                                <div style="font-weight: 600;">{{ veiculo.placa or cab.placa or '-' }}</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">{{ viagem.nome or '-' }}</div>
                            </td>
                            <td class="hide-mobile">
                                {% if viagem.partida_at %}
                                    {{ viagem.partida_at[:10].split('-')[2] }}/{{ viagem.partida_at[:10].split('-')[1] }}/{{ viagem.partida_at[:10].split('-')[0] }} - {{ viagem.partida_at[11:16] }}
                                {% elif cab.data and cab.hora %}
                                    {{ cab.data }} - {{ cab.hora }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="hide-mobile">{{ cab.km_inicial or '-' }}</td>
                            <td class="hide-mobile">{{ cab.combustivel or '-' }}</td>
                            <td>
                                <a class="btn btn-success btn-small" href="{{ url_for('finalizar_relatorio', relatorio_id=viagem.id) }}">Finalizar</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="empty-state">Nenhuma viagem em andamento.</p>
    {% endif %}
</section>
{% endblock %}

{% block scripts %}
<style>
    /* Toggle Switch para notificações */
    .switch {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 24px;
    }
    
    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }
    
    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    
    input:checked + .slider {
        background-color: #4CAF50;
    }
    
    input:focus + .slider {
        box-shadow: 0 0 1px #4CAF50;
    }
    
    input:checked + .slider:before {
        transform: translateX(24px);
    }
</style>
<script>
    // Toggle de notificações
    const notificationToggle = document.getElementById('notification-toggle');
    if (notificationToggle) {
        notificationToggle.addEventListener('change', async (e) => {
            const notificacao = notificationToggle.checked;
            
            console.log('Toggle clicado. Estado:', notificacao);
            
            try {
                const response = await fetch('/admin/minha-notificacao', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ notificacao: notificacao }),
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Resposta:', data);
                    
                    // Mostra feedback visual
                    const msg = notificacao ? 'Notificações ativadas ✓' : 'Notificações desativadas';
                    const tempMsg = document.createElement('div');
                    tempMsg.textContent = msg;
                    tempMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; z-index: 9999; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                    document.body.appendChild(tempMsg);
                    setTimeout(() => tempMsg.remove(), 3000);
                } else {
                    const errorData = await response.text();
                    console.error('Erro do servidor:', errorData);
                    alert('Erro ao atualizar configuração de notificações');
                    notificationToggle.checked = !notificacao;
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
                alert('Erro ao atualizar configuração de notificações');
                notificationToggle.checked = !notificacao;
            }
        });
    }

    // Atualiza os stats do dashboard em tempo real sem recarregar a página
    document.addEventListener('DOMContentLoaded', () => {
        const REFRESH_MS = 30000; // 30 segundos
        
        async function updateStats() {
            try {
                const response = await fetch('/api/admin/stats', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    // Atualiza cada stat card sem recarregar a página
                    const statCards = {
                        'stat-relatorios': stats.relatorios,
                        'stat-avarias': stats.avarias,
                        'stat-usuarios': stats.usuarios,
                        'stat-veiculos': stats.veiculos,
                        'stat-abastecimentos': stats.abastecimentos,
                    };
                    
                    for (const [id, value] of Object.entries(statCards)) {
                        const element = document.querySelector('.stat-value');
                        // Atualiza múltiplos elementos
                    }
                }
            } catch (error) {
                console.log('Erro ao atualizar stats:', error);
            }
        }
        
        // Não recarrega automaticamente a página - apenas atualiza dados via API
        // setInterval(updateStats, REFRESH_MS);
    });
</script>
{% endblock %}
